var m=require("path"),C=require("react"),y=require("node:fs/promises"),I=require("html-minifier").minify,x=require("react-dom/server"),{renderToString:q}=x,{readFile:S,writeFile:v,cp:F,readdir:O}=y,p=process.cwd(),h=e=>typeof e=="string"&&e.length>0,P=e=>{let s=m.basename(e,m.extname(e)),t=s.substring(0,s.indexOf(".static"));return`${t.slice(0,1).toLowerCase()}${t.slice(1)}`},b=(e,s,t)=>{if(!e.includes(t))return{};let r=e.indexOf(t)+t.length+1,c=s-2,n=e.substring(r,c);try{let o=JSON.parse(n);return console.log(`${t}`,o),o}catch(o){return console.error(`Can't parse ${n} from html:`,o.message),{}}},D=(e,s)=>{let t=require(e);return t.default&&(t=t.default),q(C.createElement(t,{data:s}))},E=(e,s,t,r)=>{let c=s.substring(0,t+r),n=s.substring(t+r);return`${c}${e}${n}`};module.exports=(e={})=>{let s=h(e.outDir)?`${p}/${e.outDir}`:`${p}/out`,t=h(e.pages)?`${p}/${e.pages}`:null,r=[];return{name:"reactStaticPlugin",setup:c=>{c.onStart(async()=>{try{if(!t)throw new Error("Must specify a html page");await F(t,s,{recursive:!0});let o=(await O(t)).map(async i=>new Promise((u,d)=>{let l=`${s}/${i}`;S(l,"utf8").then(a=>{a||d(`Can't read file ${i}`),u({path:l,content:a})}).catch(a=>d(a))}));r=await Promise.all(o)}catch(n){console.error("Can't read files",n.message)}}),c.onLoad({filter:/\.static.jsx$/},n=>{let o=n.path,i=P(o),u=`id="${i}">`,d=`data-${i}=`;for(let l=0;l<r.length;l++){let a=r[l],g=I(a.content,{collapseWhitespace:!0,conservativeCollapse:!0,caseSensitive:!0});if(g.includes(u)){let f=g.indexOf(u),$=b(g,f,d),w=D(o,$);a.content=E(w,g,f,u.length),console.log("Component:",i),console.log("Injected in:",a.path),console.log("-------------------------------------------"),console.log("-------------------------------------------")}}return{loader:"jsx"}}),c.onEnd(async()=>{for(let n=0;n<r.length;n++){let o=r[n];await v(o.path,o.content)}})}}};