var m=require("path"),C=require("react"),I=require("node:fs/promises"),x=require("html-minifier").minify,F=require("react-dom/server"),{renderToString:P}=F,{readFile:q,writeFile:v,cp:S,readdir:D}=I,p=process.cwd(),h=t=>typeof t=="string"&&t.length>0,O=t=>{let n=m.basename(t,m.extname(t)),e=n.substring(0,n.indexOf(".static"));return`${e.slice(0,1).toLowerCase()}${e.slice(1)}`},b=(t,n,e)=>{if(!t.includes(e))return{};let s=t.indexOf(e)+e.length+1,a=n-2,o=t.substring(s,a);try{let r=JSON.parse(o);return console.log(`${e}`,r),r}catch(r){return console.error(`Can't parse ${o} from html:`,r.message),{}}},E=(t,n)=>{let e=require(t);return e.default&&(e=e.default),P(C.createElement(e,{data:n}))},R=(t,n,e,s)=>{let a=n.substring(0,e+s),o=n.substring(e+s);return`${a}${t}${o}`},$=async t=>{let n=await D(t,{withFileTypes:!0}),e=await Promise.all(n.map(s=>{let a=m.resolve(t,s.name);return s.isDirectory()?$(a):a}));return Array.prototype.concat(...e)};module.exports=(t={})=>{let n=h(t.outDir)?`${p}/${t.outDir}`:`${p}/out`,e=h(t.pages)?`${p}/${t.pages}`:null,s=[];return{name:"reactStaticPlugin",setup:a=>{a.onStart(async()=>{try{if(!e)throw new Error("Must specify a html page");await S(e,n,{recursive:!0});let r=(await $(n)).map(async i=>new Promise((l,u)=>{q(i,"utf8").then(c=>{c||u(`Can't read file ${i}`),l({path:i,content:c})}).catch(c=>u(c))}));s=await Promise.all(r)}catch(o){console.error("Can't read files",o.message)}}),a.onLoad({filter:/\.static.jsx$/},o=>{let r=o.path,i=O(r),l=`id="${i}">`,u=`data-${i}=`;for(let c=0;c<s.length;c++){let g=s[c],d=x(g.content,{collapseWhitespace:!0,conservativeCollapse:!0,caseSensitive:!0});if(d.includes(l)){let f=d.indexOf(l),y=b(d,f,u),w=E(r,y);g.content=R(w,d,f,l.length),console.log("Component:",i),console.log("Injected in:",g.path),console.log("-------------------------------------------"),console.log("-------------------------------------------")}}return{loader:"jsx"}}),a.onEnd(async()=>{for(let o=0;o<s.length;o++){let r=s[o];await v(r.path,r.content)}})}}};