var F=Object.create;var h=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var O=Object.getPrototypeOf,R=Object.prototype.hasOwnProperty;var b=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of S(e))!R.call(t,o)&&o!==n&&h(t,o,{get:()=>e[o],enumerable:!(r=D(e,o))||r.enumerable});return t};var l=(t,e,n)=>(n=t!=null?F(O(t)):{},b(e||!t||!t.__esModule?h(n,"default",{value:t,enumerable:!0}):n,t));var m=l(require("path")),d=l(require("react")),$=l(require("node:fs/promises")),P=l(require("html-minifier")),v=l(require("react-dom/server")),{minify:j}=P.default,{renderToString:w}=v.default,{readFile:A,writeFile:M,cp:N,readdir:T}=$.default,p=process.cwd(),y=t=>typeof t=="string"&&t.length>0,C=async t=>{let e=await T(t,{withFileTypes:!0}),n=await Promise.all(e.map(r=>{let o=m.default.resolve(t,r.name);return r.isDirectory()?C(o):o}));return Array.prototype.concat(...n)},H=async t=>{let e=[];try{let n=t.map(async r=>new Promise((o,a)=>{A(r,"utf8").then(s=>{s||a(`Can't read file ${r}`);let c=j(s,{caseSensitive:!0,collapseWhitespace:!0,conservativeCollapse:!0});o({path:r,content:c})}).catch(s=>a(s))}));e=await Promise.all(n)}catch(n){console.error("Can't read files",n.message)}finally{return e}},L=t=>{let e=m.default.basename(t,m.default.extname(t)),n=e.substring(0,e.indexOf(".static"));return`${n.slice(0,1).toLowerCase()}${n.slice(1)}`},U=t=>{let{content:e,attrData:n,attrId:r,componentPath:o,suffix:a,redux:s}=t,c=e.indexOf(r),i=J(e,c,n),u=W(o,i,a,s);return Y(u,e,c,r.length)},J=(t,e,n)=>{if(!t.includes(n))return{};let r=t.indexOf(n)+n.length+1,o=e-2,a=t.substring(r,o);try{let s=JSON.parse(a);return console.log(`${n}`,s),s}catch(s){return console.error(`Can't parse ${a} from html:`,s.message),{}}},W=async(t,e,n,r)=>{let o=await import(t);o.default&&(o=o.default);let a=d.default.createElement(o,{data:e});if(n.includes("provider"))if(r.store&&r.Provider){let{store:s,Provider:c}=r;return w(d.default.createElement(c,{store:s},a))}else throw new Error(`You must provide a store and Provider for ${t}`);else return w(a)},Y=(t,e,n,r)=>{let o=e.substring(0,n+r),a=e.substring(n+r);return`${o}${t}${a}`};module.exports=(t={})=>{let e=y(t.outDir)?`${p}/${t.outDir}`:`${p}/out`,n=y(t.pages)?`${p}/${t.pages}`:null,r=t.redux||{store:null,Provider:null},o=[];return{name:"reactStaticPlugin",setup:a=>{a.onStart(async()=>{try{if(!n)throw new Error("Must specify a html page");await N(n,e,{recursive:!0});let s=await C(e);o=await H(s)}catch(s){console.error("Can't get html outputs paths",s.message)}}),a.onLoad({filter:/\.static.jsx$/},s=>{let c=s.path,i=L(c),u=`id="${i}">`,x=`data-${i}=`;for(let f of o){let{content:g,path:I}=f;if(!g.includes(u))continue;let E={redux:r,attrId:u,content:g,attrData:x,componentPath:c,suffix:s.suffix};f.content=U(E),console.log("Component:",i),console.log("Injected in:",I),console.log("-------------------------------------------"),console.log("-------------------------------------------")}return{loader:"jsx"}}),a.onEnd(async()=>{for(let s of o)await M(s.path,s.content)})}}};